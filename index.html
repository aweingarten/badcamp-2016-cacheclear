<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>External Caching in D8: Cache clear all the things!</title>
    <meta name="author" content="Adam Weingarten">
    <meta name="author" content="Niels van Mourik">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
    <link rel="stylesheet" href="src/reveal/css/reveal.css">
    <link rel="stylesheet" href="src/reveal/css/theme/moon.css" id="theme">
    <link rel="stylesheet" href="src/reveal/lib/css/zenburn.css">
    <link rel="stylesheet" href="src/style.css">
    <script><!-- Printing and PDF exports -->
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'src/reveal/css/print/pdf.css' : 'src/reveal/css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>
    <!--[if lt IE 9]>
    <script src="src/reveal/lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section data-markdown data-separator="^\n---\n$" data-separator-vertical="^\n---$"><script type="text/template">
          # External caching in D8
          ## _Cache clear all the things!_
        </script></section>
        <section data-markdown data-separator="^\n---\n$" data-separator-vertical="^\n---$"><script type="text/template">
          # What is caching actually?
          #### AKA: The problem we're trying to solve

          ---
          # Your webserver sucks!

          ---
          # Slide 1

          **Foo.**<!-- .element: class="fragment" -->

          **Bar.**<!-- .element: class="fragment" -->

          **Baz (max three bullets if possible).**<!-- .element: class="fragment" -->

          ---
          # Slide 2

          **Foo.**<!-- .element: class="fragment" -->

          **Bar.**<!-- .element: class="fragment" -->

          **Baz (max three bullets if possible).**<!-- .element: class="fragment" -->
        </script></section>

        <section data-markdown data-separator="^\n---\n$" data-separator-vertical="^\n---$"><script type="text/template">
          # External Caching in D7
          ### _bandaid at work_

          ---
          ## Internal page cache

          **URL-based registry that keeps full-HTML copies of pages.**<!-- .element: class="fragment" -->

          **Considered a life-saver for anonymous traffic.**<!-- .element: class="fragment" -->

          **Except that... in real-life, it's far from effective :-(**<!-- .element: class="fragment" -->

          ---
          # _Editing just one node..._<!-- .element: class="fragment" -->
          # _<ins>Deletes ALL other cached pages!</ins>_<!-- .element: class="fragment" -->

          ---
          ## Now what if a CDN or
          ## something like Varnish would cache
          ## and serve Drupal's content?

          ---
          ### _(imagine British accent)_
          # Splendid...<!-- .element: class="fragment" -->
          # Thinking<!-- .element: class="fragment" -->
          # Mate!<!-- .element: class="fragment" -->

          ---
          ## We just need this in settings.php:<!-- .element: class="fragment" -->

          ```
          $conf['page_cache_maximum_age'] = 31536000;
          ```<!-- .element: class="fragment" -->

          ** The external layer will cache everything for a whole year!  **<!-- .element: class="fragment" -->

          # Problem solved?<!-- .element: class="fragment" -->

          ---
          ## Absolutely fabulous performance

          **Until you edit a page...**<!-- .element: class="fragment" -->

          **...and have it stuck in cache for the rest of the year!**<!-- .element: class="fragment" -->

          # Blimey, Sherlock!<!-- .element: class="fragment" -->

          ---
          ## The _``expire``_ module
          ###### _Formally known as "Cache Expiration"_

          **Fires off a hook - with a list of URLs - when content changes.**<!-- .element: class="fragment" -->

          **Then modules like ``varnish`` or ``acquia_purge`` invalidate...**<!-- .element: class="fragment" -->

          **Detects basics, like ``node_save()`` and taxonomy terms.**<!-- .element: class="fragment" -->

          ### <ins>This allows invalidating only what changed,<br /> keeping old content cached virtually endlessly!</ins><!-- .element: class="fragment" -->

          ---
          ![](img/acquia-purge-queuing-elb-support.png)

          ---
          ## The wonky downsides...

          **Guesses up to 60% of changes, rules to "fill in the gaps".**<!-- .element: class="fragment" -->

          **You've got 100 page view. Edited a node, view stays cached!**<!-- .element: class="fragment" -->

          **Too many incompatible modules that don't play along well.**<!-- .element: class="fragment" -->

          **_fire and forget_: overwhelming as URLs are uniquely cached.**<!-- .element: class="fragment" -->

          ---
          ### _(imagine British accent)_
          ## but,...<!-- .element: class="fragment" -->
          # Isn't that mad<br />as a bag of ferrets?<!-- .element: class="fragment" -->
        </script></section>
        <section data-markdown data-separator="^\n---\n$" data-separator-vertical="^\n---$"><script type="text/template">
          # Enter D8:<br />cache Tags

          ---
          # _caching rearchitected_

          ---
          ## A proper generic cache API

          **Same old ``get()``, ``set()`` logic at heart!**<!-- .element: class="fragment" -->

          ** Allows tagging of aribtrary cached items.**<!-- .element: class="fragment" -->

          ** Cache::invalidateTags(["tag"])**<!-- .element: class="fragment" -->

          ** CacheTagsListenersInterface**<!-- .element: class="fragment" -->


          ---
          ## Generating content became
          ## very cheap and efficiency
          ## increased tremendously!

          ---
          ### Has a proper render API and pipeline
          ![](img/render_pipeline.png)

          ---
          ### Rendering visualized
          ![](img/render_pipeline_graph.png)

          ---
          ** Each single item is described with tags.**<!-- .element: class="fragment" -->

          ** Tags "bubble" up to all rendering parents.**<!-- .element: class="fragment" -->

          ** These tags are stored in the cache API.**<!-- .element: class="fragment" -->

          ---
          ### When content changes

          ** The content API's call ::invalidateTags().**<!-- .element: class="fragment" -->

          ** The render and page caches are transparently invalidated.**<!-- .element: class="fragment" -->

          ---
          # Result?

          # Happy Drupal<!-- .element: class="fragment" -->
        </script></section>
        <section data-markdown data-separator="^\n---\n$" data-separator-vertical="^\n---$"><script type="text/template">
          # The _Purge_&nbsp; module

          ---
          # The Purge module

          **Generic middleware for all external cache invalidation.**<!-- .element: class="fragment" -->

          **Plugin based architecture with clean and decoupled APIs.**<!-- .element: class="fragment" -->

          **Mandatory queuing enforces asynchronous processing.**<!-- .element: class="fragment" -->

          drupal.org/project/[**purge**](https://drupal.org/project/purge)

          ---
          # How Purge works

          **Listens and queues.**<!-- .element: class="fragment" -->

          **Queue processing strategies configurable.**<!-- .element: class="fragment" -->

          **Pipeline: purge_purger_http, cloudflare, akamai.**<!-- .element: class="fragment" -->

          drupal.org/project/[**purge**](https://drupal.org/project/purge)

          ---
          ## D8 + purge + varnish =

          ![](img/happy_cdn.png)<!-- .element: class="fragment" -->

          ---
          # Acquia

          **Runs thousands of varnishd instances.**<!-- .element: class="fragment" -->

          **In a massive operation to move to Varnish 4.**<!-- .element: class="fragment" -->

          **Expects full D8 purge support soon!**<!-- .element: class="fragment" -->


        </script></section>
        <section data-markdown data-separator="^\n---\n$" data-separator-vertical="^\n---$"><script type="text/template">
          # Implementations

          ---
          # Slide 1

          **Foo.**<!-- .element: class="fragment" -->

          **Bar.**<!-- .element: class="fragment" -->

          **Baz (max three bullets if possible).**<!-- .element: class="fragment" -->

          ---
          # Slide 2

          **Foo.**<!-- .element: class="fragment" -->

          **Bar.**<!-- .element: class="fragment" -->

          **Baz (max three bullets if possible).**<!-- .element: class="fragment" -->

        </script></section>
        <section data-markdown data-separator="^\n---\n$" data-separator-vertical="^\n---$"><script type="text/template">
          # That was it!

          ---
          # Questions?

          ---
          # Questions?
          ### Catch us around here!
          * Slides at [goo.gl/WlLy80](https://github.com/nielsvm/talk-20160722-cache-clear-all-the-things)
          * [adam.weingarten@acquia.com](adam.weingarten@acquia.com)
          * [niels.vanmourik@acquia.com](niels.vanmourik@acquia.com)
          * [drupal.org/project/purge](https://www.drupal.org/project/purge)
          * [drupal.org/project/cloudflare](https://www.drupal.org/project/cloudflare)
        </script></section>

        <div class='footer'>
          <ul id="footerlist">
            <li class="transparency"><span id="time"></span></li>
            <li class="transparency"><i>Cache clear all the things!</i></li>
            <li class="transparency"><a href="mailto:adam@weingarten.me" target="_blank">Adam Weingarten</a></li>
            <li class="transparency">&</li>
            <li class="transparency"><a href="https://twitter.com/_nielsvm" target="_blank">Niels van Mourik</a></li>
            <li><a href="http://www.acquia.com/" target="_blank"><img src="img/acquia-logo-think-ahead-white-tiny.svg" /></a></li>
          </ul>
        </div>
      </div>
      <script src="src/reveal/lib/js/head.min.js"></script>
      <script src="src/reveal/js/reveal.js" /></script>
      <script src="src/configuration.js" /></script>
      <script src="src/stopwatch.js" /></script>
        <script><!-- Printing and PDF exports -->
          show();
          start();
      </script>
    </div>
  </body>
</html>
